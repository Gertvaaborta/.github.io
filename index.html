<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russia Trails | Регистрация</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS для карты -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet Fullscreen -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.css" />
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            display: flex;
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .welcome-section {
            flex: 1;
            background: linear-gradient(rgba(26, 41, 128, 0.8), rgba(38, 208, 206, 0.8)), 
                        url('https://images.unsplash.com/photo-1513326738677-b964603b136d?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 50px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .welcome-section h1 {
            font-size: 32px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .welcome-section p {
            font-size: 16px;
            opacity: 0.9;
            line-height: 1.5;
        }

        .form-section {
            flex: 1;
            padding: 40px 30px;
        }

        .logo {
            color: #1a2980;
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 25px;
            text-align: center;
        }

        .form-container {
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-title {
            font-size: 22px;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            border-color: #1a2980;
            outline: none;
        }

        .checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .checkbox input {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(26, 41, 128, 0.3);
        }

        .switch-form {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .switch-form a {
            color: #1a2980;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .switch-form a:hover {
            text-decoration: underline;
        }

        #map-container {
            display: none;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .map-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .map-btn:hover {
            transform: translateY(-2px);
        }

        .btn-add {
            background: #1a2980;
            color: white;
        }

        .btn-save {
            background: #26d0ce;
            color: white;
        }

        .btn-list {
            background: #4CAF50;
            color: white;
        }

        .btn-back {
            background: #f44336;
            color: white;
        }

        .mobile-warning {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                max-width: 95%;
                margin: 10px auto;
            }
            
            .welcome-section {
                padding: 30px 25px;
            }
            
            .form-section {
                padding: 30px 25px;
            }
            
            .welcome-section h1 {
                font-size: 26px;
            }
            
            .mobile-warning {
                display: block;
            }
            
            .map-controls {
                top: 5px;
                right: 5px;
                padding: 10px;
            }
            
            .map-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Стартовое окно -->
    <div id="start-container" class="container">
        <div class="welcome-section">
            <h1>Добро пожаловать в Russia Trails</h1>
            <p>Откройте для себя Россию: её бескрайние просторы, уникальные природные ландшафты и богатое культурное наследие.</p>
        </div>
        <div class="form-section">
            <div class="logo"><i class="fas fa-map-marked-alt"></i> RUSSIA TRAILS</div>
            
            <div class="mobile-warning">
                <i class="fas fa-mobile-alt"></i> Для лучшего опыта используйте полную версию на компьютере
            </div>
            
            <!-- Форма входа -->
            <div id="login-form" class="form-container active">
                <h2 class="form-title">Вход в аккаунт</h2>
                <form id="loginForm">
                    <div class="input-group">
                        <label for="login-email"><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="login-email" placeholder="ваш@email.com" required>
                    </div>
                    <div class="input-group">
                        <label for="login-password"><i class="fas fa-lock"></i> Пароль</label>
                        <input type="password" id="login-password" placeholder="Введите пароль" required>
                    </div>
                    <div class="checkbox">
                        <input type="checkbox" id="remember">
                        <label for="remember">Запомнить меня</label>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-sign-in-alt"></i> Войти</button>
                </form>
                <div class="switch-form">
                    Нет аккаунта? <a id="to-register">Зарегистрироваться</a>
                </div>
            </div>
            
            <!-- Форма регистрации -->
            <div id="register-form" class="form-container">
                <h2 class="form-title">Регистрация</h2>
                <form id="registerForm">
                    <div class="input-group">
                        <label for="reg-name"><i class="fas fa-user"></i> Имя</label>
                        <input type="text" id="reg-name" placeholder="Ваше имя" required>
                    </div>
                    <div class="input-group">
                        <label for="reg-email"><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="reg-email" placeholder="ваш@email.com" required>
                    </div>
                    <div class="input-group">
                        <label for="reg-password"><i class="fas fa-lock"></i> Пароль</label>
                        <input type="password" id="reg-password" placeholder="Придумайте пароль" required>
                    </div>
                    <div class="input-group">
                        <label for="reg-confirm"><i class="fas fa-lock"></i> Подтвердите пароль</label>
                        <input type="password" id="reg-confirm" placeholder="Повторите пароль" required>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-user-plus"></i> Зарегистрироваться</button>
                </form>
                <div class="switch-form">
                    Уже есть аккаунт? <a id="to-login">Войти</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер для карты -->
    <div id="map-container">
        <div id="map"></div>
        <div class="map-controls">
            <button class="map-btn btn-add" onclick="addRoutePoint()">
                <i class="fas fa-map-marker-alt"></i> Добавить точку
            </button>
            <button class="map-btn btn-save" onclick="saveRoute()">
                <i class="fas fa-save"></i> Сохранить маршрут
            </button>
            <button class="map-btn btn-list" onclick="showRouteList()">
                <i class="fas fa-list"></i> Мои маршруты
            </button>
            <button class="map-btn btn-back" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.js"></script>

    <script>
        // ==================== КОНФИГУРАЦИЯ SUPABASE ====================
        // ⚠️ ЗАМЕНИТЕ ЭТИ ДАННЫЕ НА ВАШИ С КОНСОЛИ SUPABASE!
        const supabaseUrl = 'https://ваш-проект.supabase.co';
        const supabaseKey = 'ваш-public-anon-key';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Глобальные переменные для карты
        let currentMap = null;
        let routePoints = [];
        let routeMarkers = [];
        let routeLine = null;
        
        // ==================== ПЕРЕКЛЮЧЕНИЕ ФОРМ ====================
        document.getElementById('to-register').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-form').classList.remove('active');
            document.getElementById('register-form').classList.add('active');
        });

        document.getElementById('to-login').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('register-form').classList.remove('active');
            document.getElementById('login-form').classList.add('active');
        });

        // ==================== РЕГИСТРАЦИЯ С SUPABASE ====================
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;
            
            if (!name || !email || !password || !confirm) {
                alert('Заполните все поля!');
                return;
            }
            
            if (password !== confirm) {
                alert('Пароли не совпадают!');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });
                
                if (error) throw error;
                
                alert(`Регистрация успешна! Добро пожаловать, ${name}! Проверьте почту для подтверждения.`);
                console.log('Пользователь зарегистрирован:', data.user);
                showMap();
                
            } catch (error) {
                alert('Ошибка регистрации: ' + error.message);
                console.error('Ошибка регистрации:', error);
            }
        });

        // ==================== ВХОД С SUPABASE ====================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Заполните все поля!');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                alert('Вход выполнен успешно! Добро пожаловать!');
                console.log('Пользователь вошёл:', data.user);
                showMap();
                
            } catch (error) {
                alert('Ошибка входа: ' + error.message);
                console.error('Ошибка входа:', error);
            }
        });

        // ==================== ИНИЦИАЛИЗАЦИЯ КАРТЫ ====================
        function showMap() {
            try {
                document.getElementById('start-container').style.display = 'none';
                const mapContainer = document.getElementById('map-container');
                mapContainer.style.display = 'block';
                
                // Создаем карту (центр - Москва, масштаб 5)
                currentMap = L.map('map').setView([55.7558, 37.6176], 5);
                
                // Добавляем OpenStreetMap слой
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap',
                    maxZoom: 19
                }).addTo(currentMap);
                
                // Добавляем полноэкранный режим
                currentMap.addControl(new L.Control.Fullscreen());
                
                // Обработчик клика по карте
                currentMap.on('click', function(e) {
                    addMarkerAt(e.latlng);
                });
                
                // Сбрасываем старые точки
                routePoints = [];
                routeMarkers = [];
                routeLine = null;
                
                console.log("Карта OpenStreetMap загружена");
                
            } catch (error) {
                console.error("Ошибка карты:", error);
                alert("Ошибка загрузки карты");
            }
        }

        // ==================== РАБОТА С МАРШРУТАМИ ====================
        function addMarkerAt(latlng) {
            if (!currentMap) return;
            
            const marker = L.marker(latlng).addTo(currentMap)
                .bindPopup(`Точка ${routePoints.length + 1}<br>Широта: ${latlng.lat.toFixed(4)}<br>Долгота: ${latlng.lng.toFixed(4)}`)
                .openPopup();
            
            routePoints.push({ lat: latlng.lat, lng: latlng.lng });
            routeMarkers.push(marker);
            
            // Рисуем линию между точками
            if (routePoints.length > 1) {
                if (routeLine) {
                    currentMap.removeLayer(routeLine);
                }
                routeLine = L.polyline(routePoints.map(p => [p.lat, p.lng]), {
                    color: '#1a2980',
                    weight: 3
                }).addTo(currentMap);
            }
        }

        function addRoutePoint() {
            if (currentMap) {
                const center = currentMap.getCenter();
                addMarkerAt(center);
            }
        }

        async function saveRoute() {
            if (routePoints.length === 0) {
                alert("Добавьте точки на карту!");
                return;
            }
            
            const routeName = prompt("Название маршрута:", `Маршрут ${new Date().toLocaleDateString()}`);
            if (!routeName) return;
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert("Войдите в аккаунт!");
                    return;
                }
                
                const { data, error } = await supabase
                    .from('routes')
                    .insert([{
                        user_id: user.id,
                        name: routeName,
                        points: routePoints,
                        created_at: new Date()
                    }])
                    .select();
                
                if (error) throw error;
                
                alert(`Маршрут "${routeName}" сохранен!`);
                
                // Очищаем карту
                routePoints = [];
                routeMarkers.forEach(m => currentMap.removeLayer(m));
                routeMarkers = [];
                if (routeLine) {
                    currentMap.removeLayer(routeLine);
                    routeLine = null;
                }
                
            } catch (error) {
                alert("Ошибка: " + error.message);
            }
        }

        async function showRouteList() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert("Войдите в аккаунт!");
                    return;
                }
                
                const { data: routes, error } = await supabase
                    .from('routes')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!routes || routes.length === 0) {
                    alert("Нет сохраненных маршрутов");
                    return;
                }
                
                let list = "Ваши маршруты:\n\n";
                routes.forEach((r, i) => {
                    list += `${i+1}. ${r.name}\n   Точек: ${r.points.length}\n   Дата: ${new Date(r.created_at).toLocaleDateString()}\n\n`;
                });
                
                const choice = prompt(`${list}\nВведите номер маршрута для просмотра:`);
                if (choice && routes[choice-1]) {
                    showSavedRoute(routes[choice-1]);
                }
                
            } catch (error) {
                alert("Ошибка загрузки: " + error.message);
            }
        }

        function showSavedRoute(route) {
            // Очищаем текущий маршрут
            routePoints = [];
            routeMarkers.forEach(m => currentMap.removeLayer(m));
            routeMarkers = [];
            if (routeLine) {
                currentMap.removeLayer(routeLine);
                routeLine = null;
            }
            
            // Отображаем сохраненный маршрут
            route.points.forEach(point => {
                addMarkerAt(L.latLng(point.lat, point.lng));
            });
            
            // Центрируем карту
            if (route.points.length > 0) {
                currentMap.setView([route.points[0].lat, route.points[0].lng], 10);
            }
            
            alert(`Маршрут "${route.name}" загружен!`);
        }

        // ==================== ВОЗВРАТ НАЗАД ====================
        function goBack() {
            document.getElementById('map-container').style.display = 'none';
            document.getElementById('start-container').style.display = 'flex';
            
            if (currentMap) {
                currentMap.remove();
                currentMap = null;
            }
        }

        // ==================== АВТОЗАПОЛНЕНИЕ ДЛЯ ТЕСТА ====================
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                document.getElementById('login-email').value = 'test@example.com';
                document.getElementById('login-password').value = 'password123';
            }, 500);
        });
    </script>
</body>
</html>
