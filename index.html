<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Russia Trails | Путешествия по России</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          crossorigin=""/>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        /* ========== ОСНОВНОЙ КОНТЕЙНЕР ========== */
        .app-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* Шапка */
        .app-header {
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            padding: 18px 20px;
            text-align: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* Основной контент */
        .app-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0;
            background: #f8f9fa;
        }

        /* Секции (скрыты по умолчанию) */
        .page-section {
            display: none;
            min-height: 100%;
            padding-bottom: 80px; /* Отступ для таб-бара */
        }

        .page-section.active {
            display: block;
        }

        /* ========== ГЛАВНАЯ (КАРТА) ========== */
        #map {
            width: 100%;
            height: calc(100vh - 130px);
            border-radius: 0;
        }

        .map-controls {
            position: absolute;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #1a2980;
            cursor: pointer;
            transition: all 0.2s;
        }

        .map-btn:active {
            transform: scale(0.9);
        }

        /* ========== МАРШРУТЫ ========== */
        .routes-container {
            padding: 20px;
        }

        .section-title {
            font-size: 24px;
            color: #1a2980;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .routes-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .routes-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .route-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .route-card:active {
            transform: scale(0.98);
        }

        .route-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .route-info {
            padding: 20px;
        }

        .route-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .route-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            color: #666;
            font-size: 14px;
        }

        .route-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .route-tag {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1a2980;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        /* ========== СТРАНИЦА МАРШРУТА ========== */
        .route-detail-page {
            background: white;
            min-height: 100%;
        }

        .route-detail-header {
            position: relative;
        }

        .route-detail-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #333;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .route-detail-content {
            padding: 25px 20px;
        }

        .route-detail-title {
            font-size: 28px;
            color: #1a2980;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .route-stats {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a2980;
            display: block;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .section-subtitle {
            font-size: 20px;
            color: #333;
            margin: 25px 0 15px;
            font-weight: 600;
        }

        .route-description {
            color: #555;
            line-height: 1.6;
            font-size: 16px;
            margin-bottom: 25px;
        }

        .route-points {
            list-style: none;
        }

        .route-point {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 18px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .point-number {
            width: 30px;
            height: 30px;
            background: #1a2980;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .point-text {
            flex: 1;
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid #eee;
        }

        @media (min-width: 768px) {
            .action-buttons {
                grid-template-columns: 1fr 1fr;
            }
        }

        .action-btn {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .btn-find {
            background: #4CAF50;
            color: white;
        }

        .btn-start {
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
        }

        /* ========== ПРОФИЛЬ ========== */
        .profile-container {
            padding: 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(to right, #1a2980, #26d0ce);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 40px;
        }

        .profile-name {
            font-size: 24px;
            color: #333;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .profile-email {
            color: #666;
            font-size: 16px;
        }

        .profile-form {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 15px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: #fafafa;
            transition: all 0.3s;
        }

        .form-input:focus {
            border-color: #1a2980;
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
        }

        .save-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        /* ========== ТАБ-БАР ========== */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            padding: 10px 0;
            z-index: 1000;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 5px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .tab-item.active {
            color: #1a2980;
        }

        .tab-item i {
            font-size: 22px;
        }

        .tab-label {
            font-weight: 500;
        }

        /* ========== ГРУППЫ ========== */
        .groups-container {
            padding: 20px;
        }

        .coming-soon {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .coming-soon i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        /* ========== АВТОРИЗАЦИЯ ========== */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .auth-modal {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            padding: 30px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            text-align: center;
        }

        .auth-tab.active {
            color: #1a2980;
            border-bottom: 2px solid #1a2980;
            margin-bottom: -2px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* ========== УТИЛИТЫ ========== */
        .hidden {
            display: none !important;
        }

        /* Оптимизация для очень маленьких экранов */
        @media (max-width: 360px) {
            .app-header {
                padding: 15px;
            }
            
            .logo {
                font-size: 18px;
            }
            
            .routes-container,
            .profile-container,
            .groups-container {
                padding: 15px;
            }
            
            .route-detail-content {
                padding: 20px 15px;
            }
            
            .tab-item {
                font-size: 11px;
            }
            
            .tab-item i {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Шапка -->
        <div class="app-header">
            <div class="logo">
                <i class="fas fa-map-marked-alt"></i>
                <span>RUSSIA TRAILS</span>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="app-content">
            <!-- Главная (Карта) -->
            <section id="home-page" class="page-section active">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="map-btn" onclick="addMarkerAtCenter()" title="Добавить точку">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                    <button class="map-btn" onclick="centerOnUser()" title="Мое местоположение">
                        <i class="fas fa-location-crosshairs"></i>
                    </button>
                </div>
            </section>

            <!-- Маршруты -->
            <section id="routes-page" class="page-section">
                <div class="routes-container">
                    <h2 class="section-title">Популярные маршруты</h2>
                    <div class="routes-grid" id="routesGrid">
                        <!-- Маршруты будут загружены через JS -->
                    </div>
                </div>
            </section>

            <!-- Детальная страница маршрута -->
            <section id="route-detail-page" class="page-section route-detail-page">
                <!-- Заполняется через JS -->
            </section>

            <!-- Группы -->
            <section id="groups-page" class="page-section">
                <div class="groups-container">
                    <h2 class="section-title">Группы</h2>
                    <div class="coming-soon">
                        <i class="fas fa-users"></i>
                        <h3>Скоро здесь будут группы</h3>
                        <p>Вы сможете находить компанию для совместных путешествий</p>
                    </div>
                </div>
            </section>

            <!-- Профиль -->
            <section id="profile-page" class="page-section">
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <h2 class="profile-name" id="profileName">Гость</h2>
                        <p class="profile-email" id="profileEmail">Войдите в аккаунт</p>
                    </div>
                    
                    <div class="profile-form" id="profileForm">
                        <div class="form-group">
                            <label class="form-label">ФИО</label>
                            <input type="text" class="form-input" id="profileFullName" placeholder="Иванов Иван Иванович" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="profileEmailInput" placeholder="ваш@email.com" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Пароль</label>
                            <input type="password" class="form-input" id="profilePassword" placeholder="••••••••" disabled>
                        </div>
                        <button class="save-btn" id="saveProfileBtn" disabled>Сохранить изменения</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Таб-бар -->
        <div class="tab-bar">
            <button class="tab-item active" data-page="home">
                <i class="fas fa-map"></i>
                <span class="tab-label">Главная</span>
            </button>
            <button class="tab-item" data-page="routes">
                <i class="fas fa-route"></i>
                <span class="tab-label">Маршруты</span>
            </button>
            <button class="tab-item" data-page="groups">
                <i class="fas fa-users"></i>
                <span class="tab-label">Группы</span>
            </button>
            <button class="tab-item" data-page="profile">
                <i class="fas fa-user"></i>
                <span class="tab-label">Профиль</span>
            </button>
        </div>

        <!-- Оверлей авторизации -->
        <div id="authOverlay" class="auth-overlay hidden">
            <div class="auth-modal">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-form="login">Вход</button>
                    <button class="auth-tab" data-form="register">Регистрация</button>
                </div>
                
                <form id="loginForm" class="auth-form active">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="ваш@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Введите пароль" required>
                    </div>
                    <button type="submit" class="save-btn">Войти</button>
                </form>
                
                <form id="registerForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label">ФИО</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Иванов Иван Иванович" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="ваш@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="Придумайте пароль" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Подтвердите пароль</label>
                        <input type="password" class="form-input" id="registerConfirm" placeholder="Повторите пароль" required>
                    </div>
                    <button type="submit" class="save-btn">Зарегистрироваться</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        // ==================== КОНФИГУРАЦИЯ SUPABASE ====================
        const supabaseUrl = 'https://jlykbogtjybqysjyjgjh.supabase.co';
        const supabaseKey = 'sb_publishable_-4KXIY05Dsd95F1RirHv3g_RiNBrdGo';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Глобальные переменные
        let currentMap = null;
        let currentUser = null;
        let routesData = [];

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupEventListeners();
            checkAuth();
            loadRoutes();
        });

        function initApp() {
            // Инициализация карты
            initMap();
            
            // Заполнение данными для демо
            populateDemoData();
        }

        // ==================== КАРТА ====================
        function initMap() {
            if (typeof L === 'undefined') {
                console.error('Leaflet не загружен');
                return;
            }
            
            currentMap = L.map('map').setView([55.7558, 37.6176], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(currentMap);
            
            // Для мобильных
            currentMap.touchZoom.enable();
            currentMap.doubleClickZoom.enable();
        }

        function addMarkerAtCenter() {
            if (!currentMap) return;
            
            const center = currentMap.getCenter();
            L.marker(center).addTo(currentMap)
                .bindPopup(`Точка маршрута<br>${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`)
                .openPopup();
        }

        function centerOnUser() {
            if (!currentMap) return;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const latlng = [position.coords.latitude, position.coords.longitude];
                    currentMap.setView(latlng, 13);
                    
                    L.marker(latlng).addTo(currentMap)
                        .bindPopup('Вы здесь')
                        .openPopup();
                });
            } else {
                alert('Геолокация не поддерживается');
            }
        }

        // ==================== МАРШРУТЫ ====================
        function loadRoutes() {
            routesData = [
                {
                    id: 1,
                    title: 'Гастрономический тур по Питеру',
                    type: 'гастрономический',
                    image: 'https://images.unsplash.com/photo-1553909489-cd47e0907980?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
                    duration: '1 ч',
                    rating: '6',
                    difficulty: 'Средняя',
                    description: 'Этот маршрут познакомит вас с самыми интересными местами города. Вы увидите архитектурные шедевры, попробуете местную кухню и почувствуете атмосферу города.',
                    points: [
                        'Отправная точка - Главная площадь',
                        'Исторический музей',
                        'Смотровая площадка',
                        'Местное кафе с аутентичной кухней',
                        'Парк для отдыха'
                    ]
                },
                {
                    id: 2,
                    title: 'Архитектурные шедевры Москвы',
                    type: 'архитектурный',
                    image: 'https://images.unsplash.com/photo-1513326738677-b964603b136d?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
                    duration: '2 ч',
                    rating: '8',
                    difficulty: 'Легкая',
                    description: 'Исследуйте архитектурное наследие столицы от древних соборов до современных небоскребов.',
                    points: [
                        'Красная площадь',
                        'Храм Василия Блаженного',
                        'Московский Кремль',
                        'Москва-Сити',
                        'Парк Зарядье'
                    ]
                },
                {
                    id: 3,
                    title: 'Исторический маршрут по Казани',
                    type: 'исторический',
                    image: 'https://images.unsplash.com/photo-1596462502278-27bfdc403348?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
                    duration: '3 ч',
                    rating: '9',
                    difficulty: 'Средняя',
                    description: 'Погрузитесь в богатую историю Татарстана, где смешались восточная и европейская культуры.',
                    points: [
                        'Казанский Кремль',
                        'Мечеть Кул-Шариф',
                        'Баумана улица',
                        'Старо-Татарская слобода',
                        'Национальный музей'
                    ]
                },
                {
                    id: 4,
                    title: 'Романтическая прогулка по Сочи',
                    type: 'настроение',
                    image: 'https://images.unsplash.com/photo-1591369824127-f6d0d8c4161d?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
                    duration: '1.5 ч',
                    rating: '7',
                    difficulty: 'Легкая',
                    description: 'Идеальный маршрут для романтической прогулки вдоль моря и по живописным паркам.',
                    points: [
                        'Морской порт',
                        'Сочинский дендрарий',
                        'Ривьера парк',
                        'Зимний театр',
                        'Набережная'
                    ]
                }
            ];
            
            renderRoutes();
        }

        function renderRoutes() {
            const routesGrid = document.getElementById('routesGrid');
            routesGrid.innerHTML = '';
            
            routesData.forEach(route => {
                const routeCard = document.createElement('div');
                routeCard.className = 'route-card';
                routeCard.innerHTML = `
                    <img src="${route.image}" alt="${route.title}" class="route-image">
                    <div class="route-info">
                        <div class="route-tag">${route.type}</div>
                        <h3 class="route-title">${route.title}</h3>
                        <div class="route-meta">
                            <span class="route-meta-item">
                                <i class="far fa-clock"></i> ${route.duration}
                            </span>
                            <span class="route-meta-item">
                                <i class="fas fa-star"></i> ${route.rating}/10
                            </span>
                            <span class="route-meta-item">
                                <i class="fas fa-chart-line"></i> ${route.difficulty}
                            </span>
                        </div>
                    </div>
                `;
                
                routeCard.addEventListener('click', () => showRouteDetail(route.id));
                routesGrid.appendChild(routeCard);
            });
        }

        function showRouteDetail(routeId) {
            const route = routesData.find(r => r.id === routeId);
            if (!route) return;
            
            const detailPage = document.getElementById('route-detail-page');
            detailPage.innerHTML = `
                <div class="route-detail-header">
                    <img src="${route.image}" alt="${route.title}" class="route-detail-image">
                    <button class="back-btn" onclick="showPage('routes')">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="route-detail-content">
                    <div class="route-tag">${route.type}</div>
                    <h1 class="route-detail-title">${route.title}</h1>
                    
                    <div class="route-stats">
                        <div class="stat-item">
                            <span class="stat-value">${route.duration}</span>
                            <span class="stat-label">Длительность</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${route.rating}/10</span>
                            <span class="stat-label">Рейтинг</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${route.difficulty}</span>
                            <span class="stat-label">Сложность</span>
                        </div>
                    </div>
                    
                    <h3 class="section-subtitle">Описание</h3>
                    <p class="route-description">${route.description}</p>
                    
                    <h3 class="section-subtitle">Точки маршрута</h3>
                    <ul class="route-points">
                        ${route.points.map((point, index) => `
                            <li class="route-point">
                                <div class="point-number">${index + 1}</div>
                                <div class="point-text">${point}</div>
                            </li>
                        `).join('')}
                    </ul>
                    
                    <div class="action-buttons">
                        <button class="action-btn btn-find" onclick="findCompany()">
                            <i class="fas fa-users"></i> Найти компанию
                        </button>
                        <button class="action-btn btn-start" onclick="startRoute(${route.id})">
                            <i class="fas fa-play"></i> Начать маршрут
                        </button>
                    </div>
                </div>
            `;
            
            showPage('route-detail');
        }

        function findCompany() {
            alert('Поиск компании для совместного путешествия...\n(Функция в разработке)');
        }

        function startRoute(routeId) {
            const route = routesData.find(r => r.id === routeId);
            if (!route) return;
            
            alert(`Начинаем маршрут: "${route.title}"\nУдачи в путешествии!`);
            showPage('home');
            
            // Можно добавить логику для отображения маршрута на карте
        }

        // ==================== ПРОФИЛЬ ====================
        function updateProfile() {
            if (!currentUser) {
                document.getElementById('profileName').textContent = 'Гость';
                document.getElementById('profileEmail').textContent = 'Войдите в аккаунт';
                document.getElementById('profileForm').classList.add('hidden');
                return;
            }
            
            document.getElementById('profileName').textContent = currentUser.user_metadata?.full_name || 'Пользователь';
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileFullName').value = currentUser.user_metadata?.full_name || '';
            document.getElementById('profileEmailInput').value = currentUser.email;
            document.getElementById('profileForm').classList.remove('hidden');
        }

        // ==================== АВТОРИЗАЦИЯ ====================
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                updateProfile();
            } else {
                showAuthModal();
            }
        }

        function showAuthModal() {
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function hideAuthModal() {
            document.getElementById('authOverlay').classList.add('hidden');
        }

        // ==================== НАВИГАЦИЯ ====================
        function showPage(pageName) {
            // Скрыть все страницы
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Показать нужную страницу
            document.getElementById(`${pageName}-page`).classList.add('active');
            
            // Обновить таб-бар
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.page === pageName) {
                    tab.classList.add('active');
                }
            });
            
            // Если переходим на главную, обновляем размер карты
            if (pageName === 'home' && currentMap) {
                setTimeout(() => {
                    currentMap.invalidateSize();
                }, 100);
            }
        }

        // ==================== ОБРАБОТЧИКИ СОБЫТИЙ ====================
        function setupEventListeners() {
            // Таб-бар
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', function() {
                    showPage(this.dataset.page);
                });
            });
            
            // Авторизация
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.form + 'Form').classList.add('active');
                });
            });
            
            // Вход
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    
                    currentUser = data.user;
                    updateProfile();
                    hideAuthModal();
                    alert('Добро пожаловать!');
                    
                } catch (error) {
                    alert('Ошибка входа: ' + error.message);
                }
            });
            
            // Регистрация
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirm = document.getElementById('registerConfirm').value;
                
                if (password !== confirm) {
                    alert('Пароли не совпадают');
                    return;
                }
                
                try {
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: name
                            }
                        }
                    });
                    
                    if (error) throw error;
                    
                    alert('✅ Регистрация успешна! Проверьте почту для подтверждения.');
                    hideAuthModal();
                    
                } catch (error) {
                    alert('Ошибка регистрации: ' + error.message);
                }
            });
            
            // Сохранение профиля
            document.getElementById('saveProfileBtn').addEventListener('click', async function(e) {
                e.preventDefault();
                
                const newName = document.getElementById('profileFullName').value;
                
                try {
                    const { error } = await supabase.auth.updateUser({
                        data: { full_name: newName }
                    });
                    
                    if (error) throw error;
                    
                    currentUser.user_metadata.full_name = newName;
                    updateProfile();
                    alert('Профиль обновлен!');
                    
                } catch (error) {
                    alert('Ошибка обновления: ' + error.message);
                }
            });
        }

        // ==================== ДЕМО ДАННЫЕ ====================
        function populateDemoData() {
            // Автозаполнение формы входа
            setTimeout(() => {
                document.getElementById('loginEmail').value = 'test@example.com';
                document.getElementById('loginPassword').value = 'password123';
            }, 1000);
        }
    </script>
</body>
</html>
